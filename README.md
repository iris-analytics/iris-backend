# iris-backend

Backend for iris-analytics.
This small app will store events generated by [iris-agent](https://github.com/iris-analytics/iris-agent) into [ClickHouse](https://clickhouse.yandex/).

There are tons of TODOs, in the meanwhile you can read Makefile.

The application stores data in [ClickHouse](https://clickhouse.yandex/) using a simple HTTP request.

- [iris-backend](#iris-backend)
  - [Run it](#run-it)
    - [From source](#from-source)
    - [From docker image](#from-docker-image)
    - [Required environment variables](#required-environment-variables)
  - [Test](#test)
  - [Request example](#request-example)

## Run it

### From source

You can execute `make run` to run the application. Make sure you create a `.env` file
(you can copy `.env.dist` and customize it according to your needs).

### From docker image

You can also run it using docker.
At the moment, we are currently offering only an image for `master` branch until it's stable and well documented.

```bash
docker pull irisanalytics/iris-backend:master
```

### Required environment variables

`iris-backend` relies on the following variables to run (if not found it will fatally exit)

- `IRIS_CLICKHOUSE_DSN`: Connection string to your `ClickHouse` instance. You can also point to [clickhouse-bulk](https://github.com/nikepan/clickhouse-bulk) or [chproxy](https://github.com/Vertamedia/chproxy).
- `IRIS_CLICKHOUSE_TABLE`: The table where data will be stored. You can have different strategies: saving to a common table, saving to a null table and create materialized views to filter entries, etc.
- `IRIS_LISTEN_BINDING`: The port the application will be listening to
- `IRIS_RECORDER_PATH`: The path [iris-agent](https://github.com/iris-analytics/iris-agent) will be pointing to. **IMPORTANT**: Avoid using words like `pixel.gif`, `pixel.gif`, `px.gif` or any other that modern ad-blockers might filter.

Example: check [.env.dist](.env.dist)

## Test

```bash
make test
```

## Request example

```bash
curl -X GET \
  'http://localhost:1777/iris/recordevent.gif?id=XX-1234567&uid=5a240440-7968-46be-ba20-b70494cff79b&sid=f6d5fe76-5296-42db-8f1d-18add142d79b&ev=pageload&ed=%7B%22foo%22%3A%22bar%22%7D&v=1&dl=http%3A%2F%2Fwww.example.com%2Ffoo&rl=http%3A%2F%2Fwww.example.com%2Fbar&ts=1567493483504&de=UTF-8&sr=1920x1080&vp=837x934&cd=24&dt=This%20is%20iris%20tracking&bn=Firefox%2068&md=false&ua=Mozilla%2F5.0%20(X11%3B%20Ubuntu%3B%20Linux%20x86_64%3B%20rv%3A68.0)%20Gecko%2F20100101%20Firefox%2F68.0&tz=-120&utm=%7B%22source%22%3A%22source%22%2C%22medium%22%3A%22medium%22%2C%22term%22%3A%22term%22%2C%22content%22%3A%22content%22%2C%22campaign%22%3A%22campaign%22%7D' \
  -H 'cache-control: no-cache'

```
